// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 髫ｨ貂可髫ｨ貂可 鬩搾ｽｨ郢晢ｽｻ繝ｻ・ｹ郢晢ｽｻ髫ｨ貂可髫ｨ貂可
model Organization {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  address   String?
  website        String?
  storeName      String?
  storeAddress   String?
  storePhone     String?
  storeHours     String?
  storeAccess    String?
  logoUrl        String?
  lineUrl        String?
  licenseNumber  String?
  createdAt DateTime @default(now())
  users              User[]
  customers          Customer[]
  statuses           Status[]
  templates          Template[]
  templateCategories TemplateCategory[]
  workflows          Workflow[]
  schedules          Schedule[]
}

// 髫ｨ貂可髫ｨ貂可 驛｢譎｢・ｽ・ｦ驛｢譎｢・ｽ・ｼ驛｢・ｧ繝ｻ・ｶ驛｢譎｢・ｽ・ｼ郢晢ｽｻ闔・･鬮ｴ・ｧ髫ｶ魃会ｽｽ・ｭ髫ｲ・｡郢晢ｽｻ繝ｻ・ｽ隶鯉ｽ｢・つ郢晢ｽｻ繝ｻ・ｼ郢晢ｽｻ髫ｨ貂可髫ｨ貂可
model User {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  email          String       @unique
  name           String
  role           UserRole     @default(MEMBER)
  createdAt      DateTime     @default(now())
  assignedCustomers Customer[] @relation("AssignedCustomers")
  messages          Message[]  @relation("SentMessages")
  auditLogs         AuditLog[]
  schedules         Schedule[]
}

enum UserRole {
  ADMIN
  MEMBER
}

// 髫ｨ貂可髫ｨ貂可 鬯ｯ蛛・ｽｽ・ｧ髯橸ｽｳ繝ｻ・｢驛｢・ｧ繝ｻ・ｹ驛｢譏ｴ繝ｻ郢晢ｽｻ驛｢・ｧ繝ｻ・ｿ驛｢・ｧ繝ｻ・ｹ 髫ｨ貂可髫ｨ貂可
model Status {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  color          String       @default("#6b7280")
  description    String?
  order          Int
  isDefault      Boolean      @default(false)
  isSystem       Boolean      @default(false)
  customers     Customer[]
  historyFrom   StatusHistory[] @relation("StatusFrom")
  historyTo     StatusHistory[] @relation("StatusTo")
}

// 髫ｨ貂可髫ｨ貂可 鬯ｯ蛛・ｽｽ・ｧ髯橸ｽｳ繝ｻ・｢ 髫ｨ貂可髫ｨ貂可
model Customer {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id])
  name             String
  nameKana         String?
  email            String?
  phone            String?
  preferredContact String?
  postalCode       String?
  address          String?
  gender           String?
  age              String?
  occupation       String?
  income           String?
  currentArea      String?
  sourcePortal     String?
  inquiryContent   String?
  statusId         String
  status           Status       @relation(fields: [statusId], references: [id])
  assigneeId       String?
  assignee         User?        @relation("AssignedCustomers", fields: [assigneeId], references: [id])
  isNeedAction     Boolean      @default(true)
  snoozedUntil     DateTime?
  lineUserId       String?
  lineDisplayName  String?
  lineLinkedAt     DateTime?
  lineBlockedAt    DateTime?
  lineCode         String?
  autoFollowActive Boolean      @default(true)
  memo             String?
  lastActiveAt     DateTime?
  lastContactAt    DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  tags            CustomerTag[]
  properties      InquiryProperty[]
  wishCondition   WishCondition?
  messages        Message[]
  schedules       Schedule[]
  workflowRuns    WorkflowRun[]
  statusHistory   StatusHistory[]
  auditLogs       AuditLog[]
}

// 髫ｨ貂可髫ｨ貂可 鬯ｯ蛛・ｽｽ・ｧ髯橸ｽｳ繝ｻ・｢驛｢・ｧ繝ｻ・ｿ驛｢・ｧ繝ｻ・ｰ 髫ｨ貂可髫ｨ貂可
model CustomerTag {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name       String
  @@unique([customerId, name])
}

// 髫ｨ貂可髫ｨ貂可 髯懶｣ｰ闕ｳ螂・ｽｼ讚∵・陋ｹ・ｻ繝ｻ蜀暦ｽｸ・ｺ陝ｶ・ｷ魄溘・閼ゅ・・ｶ 髫ｨ貂可髫ｨ貂可
model InquiryProperty {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name        String
  url         String?
  address     String?
  station     String?
  roomNumber  String?
  rent        Int?
  area        Float?
  layout      String?
  portalUrl   String?
  propertyId  String?
  inquiryId   String?
  createdAt   DateTime @default(now())
}

// 髫ｨ貂可髫ｨ貂可 髯晢ｽｶ隴ｴ・ｧ隰泌ｴ趣ｽｭ螟ｲ・ｽ・｡髣比ｼ夲ｽｽ・ｶ 髫ｨ貂可髫ｨ貂可
model WishCondition {
  id          String   @id @default(cuid())
  customerId  String   @unique
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  areas       String?
  stations    String?
  rentMin     Int?
  rentMax     Int?
  layout      String?
  walkMinutes Int?
  buildAge    Int?
  areaMin     Float?
  features    String?
  moveInDate  String?
  reason      String?
  freeText    String?
  updatedAt   DateTime @updatedAt
}

// 髫ｨ貂可髫ｨ貂可 驛｢譎｢・ｽ・｡驛｢譏ｴ繝ｻ邵ｺ譎会ｽｹ譎｢・ｽ・ｼ驛｢・ｧ繝ｻ・ｸ 髫ｨ貂可髫ｨ貂可
model Message {
  id          String        @id @default(cuid())
  customerId  String
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  senderId    String?
  sender      User?         @relation("SentMessages", fields: [senderId], references: [id])
  direction   Direction
  channel     Channel
  subject     String?
  body        String
  status      MessageStatus @default(SENT)
  externalId  String?       @unique
  deliveredAt DateTime?
  openedAt    DateTime?
  openCount   Int           @default(0)
  clickedAt   DateTime?
  clickCount  Int           @default(0)
  bouncedAt   DateTime?
  bounceReason String?
  workflowStepRunId String?
  workflowStepRun   WorkflowStepRun? @relation(fields: [workflowStepRunId], references: [id])
  createdAt   DateTime      @default(now())
  events      MessageEvent[]
}

enum Direction {
  INBOUND
  OUTBOUND
}
enum Channel {
  EMAIL
  LINE
  SMS
  CALL
  NOTE
  VISIT
}
enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

// 髫ｨ貂可髫ｨ貂可 驛｢譎｢・ｽ・｡驛｢譏ｴ繝ｻ邵ｺ譎会ｽｹ譎｢・ｽ・ｼ驛｢・ｧ繝ｻ・ｸ驛｢・ｧ繝ｻ・､驛｢譎冗函・趣ｽｦ驛｢譏ｴ繝ｻ髫ｨ貂可髫ｨ貂可
model MessageEvent {
  id         String   @id @default(cuid())
  messageId  String
  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  type       String
  occurredAt DateTime
  metadata   Json?
  createdAt  DateTime @default(now())
}

// 髫ｨ貂可髫ｨ貂可 驛｢・ｧ繝ｻ・ｹ驛｢・ｧ繝ｻ・ｱ驛｢・ｧ繝ｻ・ｸ驛｢譎｢・ｽ・･驛｢譎｢・ｽ・ｼ驛｢譎｢・ｽ・ｫ 髫ｨ貂可髫ｨ貂可
model Schedule {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String?
  customer       Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  title          String
  description    String?
  type           ScheduleType
  startAt        DateTime
  endAt          DateTime?
  isAllDay       Boolean      @default(false)
  location       String?
  color          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

enum ScheduleType {
  VISIT
  VIEWING
  CALL
  FOLLOW_UP
  OTHER
}

// 髫ｨ貂可髫ｨ貂可 驛｢譏ｴ繝ｻ・趣ｽｦ驛｢譎丞ｹｲ・取ｨ抵ｽｹ譎｢・ｽ・ｼ驛｢譎冗樟邵ｺ蜥ｲ・ｹ譏ｴ繝ｻ邵ｺ荵滂ｽｹ譎｢・ｽ・ｪ 髫ｨ貂可髫ｨ貂可
model TemplateCategory {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  order          Int
  templates      Template[]
}

// 髫ｨ貂可髫ｨ貂可 驛｢譏ｴ繝ｻ・趣ｽｦ驛｢譎丞ｹｲ・取ｨ抵ｽｹ譎｢・ｽ・ｼ驛｢譏ｴ繝ｻ髫ｨ貂可髫ｨ貂可
model Template {
  id             String           @id @default(cuid())
  organizationId String
  organization   Organization     @relation(fields: [organizationId], references: [id])
  categoryId     String
  category       TemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name           String
  channel        Channel
  subject        String?
  body           String
  order          Int              @default(0)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  workflowSteps  WorkflowStep[]
}

// 髫ｨ貂可髫ｨ貂可 驛｢譎｢・ｽ・ｯ驛｢譎｢・ｽ・ｼ驛｢・ｧ繝ｻ・ｯ驛｢譎・ｽｼ驥・ｺｽ・ｹ譎｢・ｽ・ｼ 髫ｨ貂可髫ｨ貂可
model Workflow {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  isDefault      Boolean      @default(false)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  steps          WorkflowStep[]
  runs           WorkflowRun[]
}

model WorkflowStep {
  id          String   @id @default(cuid())
  workflowId  String
  workflow    Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  name        String
  daysAfter   Int
  timeOfDay   String
  channel     Channel
  templateId  String
  template    Template @relation(fields: [templateId], references: [id])
  order       Int
  isActive    Boolean  @default(true)
  stepRuns    WorkflowStepRun[]
}

model WorkflowRun {
  id          String      @id @default(cuid())
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  workflowId  String
  workflow    Workflow     @relation(fields: [workflowId], references: [id])
  status      WFRunStatus @default(RUNNING)
  startedAt   DateTime    @default(now())
  currentStepIndex Int          @default(0)
  nextRunAt   DateTime?
  stoppedAt   DateTime?
  stopReason  String?
  stepRuns    WorkflowStepRun[]
}

enum WFRunStatus {
  RUNNING
  COMPLETED
  STOPPED_BY_REPLY
  STOPPED_BY_LINE_ADD
  STOPPED_BY_VISIT
  STOPPED_BY_CALL
  STOPPED_MANUAL
}

model WorkflowStepRun {
  id              String        @id @default(cuid())
  workflowRunId   String
  workflowRun     WorkflowRun   @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)
  stepId          String
  step            WorkflowStep  @relation(fields: [stepId], references: [id])
  status          StepRunStatus @default(PENDING)
  scheduledAt     DateTime
  executedAt      DateTime?
  errorMessage    String?
  retryCount      Int           @default(0)
  messages        Message[]
}

enum StepRunStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
  SKIPPED
}

// 髫ｨ貂可髫ｨ貂可 驛｢・ｧ繝ｻ・ｹ驛｢譏ｴ繝ｻ郢晢ｽｻ驛｢・ｧ繝ｻ・ｿ驛｢・ｧ繝ｻ・ｹ髯樊ｺｽ蛻､陝ｲ・ｩ髯橸ｽｻ繝ｻ・･髮弱・・ｽ・ｴ 髫ｨ貂可髫ｨ貂可
model StatusHistory {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  fromId     String?
  from       Status?  @relation("StatusFrom", fields: [fromId], references: [id])
  toId       String
  to         Status   @relation("StatusTo", fields: [toId], references: [id])
  changedBy  String?
  reason     String?
  createdAt  DateTime @default(now())
}

// 髫ｨ貂可髫ｨ貂可 鬨ｾ・ｶ繝ｻ・｣髫ｴ貊ゑｽｽ・ｻ驛｢譎｢・ｽ・ｭ驛｢・ｧ繝ｻ・ｰ 髫ｨ貂可髫ｨ貂可
model AuditLog {
  id         String   @id @default(cuid())
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  field      String?
  oldValue   String?
  newValue   String?
  createdAt  DateTime @default(now())
}

model LinePending {
  id             String   @id @default(cuid())
  lineUserId     String   @unique
  displayName    String?
  pictureUrl     String?
  code           String
  organizationId String   @default("org_default")
  createdAt      DateTime @default(now())
}